color = "black") +
# 主题设置
theme_bw(base_size = 12) +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
panel.border = element_rect(color = "black", linewidth = 0.5),
strip.background = element_rect(fill = "gray95", color = "gray50"),
strip.text = element_text(face = "bold", size = 11),
axis.text = element_text(color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
plot.subtitle = element_text(hjust = 0.5, size = 11)
) +
# 标签和标题
labs(
x = "Year",
y = "Relative abundance",
title = "Temporal trends",
subtitle = "Linear regression analysis with Pearson correlation"
) +
# x轴刻度
scale_x_continuous(
breaks = seq(2012, 2024, by = 4),
limits = c(2011.5, 2024.5)
) +
# y轴限制
ylim(0, 1)
# 显示图表
print(p)
# ============ 6. 保存结果 ============
# 保存图表
ggsave("Temporal_trends_plot.png", plot = p, width = 10, height = 6, dpi = 300, bg = "white")
cat("图表已保存为 'Temporal_trends_plot.png'\n")
# 保存统计结果
write.csv(stats, "Statistical_results.csv", row.names = FALSE)
cat("统计结果已保存为 'Statistical_results.csv'\n")
# 保存清洗后的数据
write.csv(data_norm, "Cleaned_normalized_data.csv", row.names = FALSE)
cat("清洗后的数据已保存为 'Cleaned_normalized_data.csv'\n")
cat("\n分析完成！\n")
setwd("/Users/hewanyun/Downloads/linear regression")
# ============ 1. 加载包 ============
library(tidyverse)
library(ggpubr)
cat("开始分析...\n")
# ============ 2. 读取和清洗数据 ============
# 读取数据
data_raw <- read.csv("Linear_data.csv", header = TRUE)
# 清洗数据：选择需要的列，移除空行
data_clean <- data_raw %>%
# 只保留前三列（Type, Year, Relative_abundance）
select(1:3) %>%
# 重命名列
rename(
Type = 1,
Year = 2,
Relative_abundance = 3
) %>%
# 移除空行
filter(!is.na(Type) & !is.na(Year)) %>%
# 转换数据类型
mutate(
Year = as.numeric(Year),
Relative_abundance = as.numeric(Relative_abundance)
) %>%
# 移除相对丰度为NA的行
filter(!is.na(Relative_abundance))
# 检查清洗后的数据
cat("数据清洗完成！\n")
cat(paste("数据行数：", nrow(data_clean), "\n"))
cat(paste("类型数量：", length(unique(data_clean$Type)), "\n"))
cat("数据预览：\n")
print(head(data_clean, 10))
# 保持 Type 按数据中出现的顺序
type_order <- unique(data_clean$Type)
data_clean <- data_clean %>%
mutate(Type = factor(Type, levels = type_order))
# ============ 3. 计算归一化值 ============
# 对每个类型分别归一化到0-1
data_norm <- data_clean %>%
group_by(Type) %>%
mutate(
# 归一化公式：(x - min) / (max - min)
Abundance_norm = (Relative_abundance - min(Relative_abundance)) /
(max(Relative_abundance) - min(Relative_abundance))
) %>%
ungroup()
# 检查归一化结果
cat("\n归一化结果检查：\n")
for(arg in unique(data_norm$Type)){
subset_data <- data_norm[data_norm$Type == arg, ]
cat(paste(arg, ": 原始范围 [",
round(min(subset_data$Relative_abundance), 3), ", ",
round(max(subset_data$Relative_abundance), 3),
"], 归一化范围 [",
round(min(subset_data$Abundance_norm), 3), ", ",
round(max(subset_data$Abundance_norm), 3), "]\n", sep = ""))
}
# ============ 4. 计算统计值 ============
cat("\n计算统计值...\n")
stats <- data_norm %>%
group_by(Type) %>%
summarise(
# 基本统计
n_points = n(),
mean_abundance = mean(Relative_abundance),
# 线性回归
slope = lm(Abundance_norm ~ Year)$coefficients[2],
p_value = summary(lm(Abundance_norm ~ Year))$coefficients[2, 4],
R2 = summary(lm(Abundance_norm ~ Year))$r.squared,
# Pearson相关
r = cor(Abundance_norm, Year, method = "pearson"),
# 用于标注的位置
label_x = min(Year) + (max(Year) - min(Year)) * 0.7,  # x位置在70%处
label_y = max(Abundance_norm) * 0.95,
.groups = "drop"
) %>%
# 格式化统计标签
mutate(
p_label = case_when(
p_value < 0.001 ~ "p < 0.001",
p_value < 0.01 ~ "p < 0.01",
p_value < 0.05 ~ sprintf("p < %.3f", p_value),
TRUE ~ sprintf("p = %.3f", p_value)
),
R2_label = sprintf("R² = %.3f", R2),
r_label = sprintf("r = %.3f", r),
# 合并标签
stat_label = paste(p_label, R2_label, r_label, sep = "\n")
)
# 显示统计结果
cat("统计结果：\n")
print(stats[, c("Type", "n_points", "p_label", "R2_label", "r_label")])
# ============ 5. 绘制图表 ============
cat("\n开始绘图...\n")
# 创建图表
p <- ggplot(data_norm, aes(x = Year, y = Abundance_norm)) +
# 数据点
geom_point(color = "#377EB8", size = 3, alpha = 0.7, shape = 16) +
# 线性回归线
geom_smooth(method = "lm", formula = y ~ x,
color = "#E41A1C", fill = "#FF9999", alpha = 0.3,
linewidth = 1.0, se = TRUE) +
# 分面显示
facet_wrap(~ Type, ncol = 2, scales = "free_y") +
# 添加统计标注
geom_text(data = stats,
aes(x = label_x, y = label_y, label = stat_label),
size = 3.5, hjust = 1, vjust = 0.5,
color = "black") +
# 添加数据点数
geom_text(data = stats,
aes(x = min(data_norm$Year),
y = max(data_norm$Abundance_norm) * 0.05,
label = paste("n =", n_points)),
size = 3, hjust = 0, vjust = 0,
color = "black") +
# 主题设置
theme_bw(base_size = 12) +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
panel.border = element_rect(color = "black", linewidth = 0.5),
strip.background = element_rect(fill = "gray95", color = "gray50"),
strip.text = element_text(face = "bold", size = 11),
axis.text = element_text(color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
plot.subtitle = element_text(hjust = 0.5, size = 11)
) +
# 标签和标题
labs(
x = "Year",
y = "Relative abundance",
title = "Temporal trends",
subtitle = "Linear regression analysis with Pearson correlation"
) +
# x轴刻度
scale_x_continuous(
breaks = seq(2012, 2024, by = 4),
limits = c(2011.5, 2024.5)
) +
# y轴限制
ylim(0, 1)
# 显示图表
print(p)
# ============ 6. 保存结果 ============
# 保存图表
#ggsave("Temporal_trends_plot.png", plot = p, width = 10, height = 6, dpi = 300, bg = "white")
#cat("图表已保存为 'Temporal_trends_plot.png'\n")
# 保存统计结果
write.csv(stats, "Statistical_results.csv", row.names = FALSE)
cat("统计结果已保存为 'Statistical_results.csv'\n")
# 保存清洗后的数据
write.csv(data_norm, "Cleaned_normalized_data.csv", row.names = FALSE)
cat("清洗后的数据已保存为 'Cleaned_normalized_data.csv'\n")
cat("\n分析完成！\n")
setwd("/Users/hewanyun/Downloads/linear regression")
# ============ 1. 加载包 ============
library(tidyverse)
library(ggpubr)
cat("开始分析...\n")
# ============ 2. 读取和清洗数据 ============
# 读取数据
data_raw <- read.csv("Linear_data.csv", header = TRUE)
# 清洗数据：选择需要的列，移除空行
data_clean <- data_raw %>%
# 只保留前三列（Type, Year, Relative_abundance）
select(1:3) %>%
# 重命名列
rename(
Type = 1,
Year = 2,
Relative_abundance = 3
) %>%
# 移除空行
filter(!is.na(Type) & !is.na(Year)) %>%
# 转换数据类型
mutate(
Year = as.numeric(Year),
Relative_abundance = as.numeric(Relative_abundance)
) %>%
# 移除相对丰度为NA的行
filter(!is.na(Relative_abundance))
# 检查清洗后的数据
cat("数据清洗完成！\n")
cat(paste("数据行数：", nrow(data_clean), "\n"))
cat(paste("类型数量：", length(unique(data_clean$Type)), "\n"))
cat("数据预览：\n")
print(head(data_clean, 10))
# 保持 Type 按数据中出现的顺序
type_order <- unique(data_clean$Type)
data_clean <- data_clean %>%
mutate(Type = factor(Type, levels = type_order))
# ============ 3. 计算归一化值 ============
# 对每个类型分别归一化到0-1
data_norm <- data_clean %>%
group_by(Type) %>%
mutate(
# 归一化公式：(x - min) / (max - min)
Abundance_norm = (Relative_abundance - min(Relative_abundance)) /
(max(Relative_abundance) - min(Relative_abundance))
) %>%
ungroup()
# 检查归一化结果
cat("\n归一化结果检查：\n")
for(arg in unique(data_norm$Type)){
subset_data <- data_norm[data_norm$Type == arg, ]
cat(paste(arg, ": 原始范围 [",
round(min(subset_data$Relative_abundance), 3), ", ",
round(max(subset_data$Relative_abundance), 3),
"], 归一化范围 [",
round(min(subset_data$Abundance_norm), 3), ", ",
round(max(subset_data$Abundance_norm), 3), "]\n", sep = ""))
}
# ============ 4. 计算统计值 ============
cat("\n计算统计值...\n")
stats <- data_norm %>%
group_by(Type) %>%
summarise(
# 基本统计
n_points = n(),
mean_abundance = mean(Relative_abundance),
# 线性回归
slope = lm(Abundance_norm ~ Year)$coefficients[2],
p_value = summary(lm(Abundance_norm ~ Year))$coefficients[2, 4],
R2 = summary(lm(Abundance_norm ~ Year))$r.squared,
# Pearson相关
r = cor(Abundance_norm, Year, method = "pearson"),
# 用于标注的位置
label_x = median(Year),
label_y = max(Abundance_norm) * 0.85,
.groups = "drop"
) %>%
# 格式化统计标签
mutate(
p_label = case_when(
p_value < 0.001 ~ "p < 0.001",
p_value < 0.01 ~ "p < 0.01",
p_value < 0.05 ~ sprintf("p < %.3f", p_value),
TRUE ~ sprintf("p = %.3f", p_value)
),
R2_label = sprintf("R² = %.3f", R2),
r_label = sprintf("r = %.3f", r),
# 合并标签
stat_label = paste(p_label, R2_label, r_label, sep = "\n")
)
# 显示统计结果
cat("统计结果：\n")
print(stats[, c("Type", "n_points", "p_label", "R2_label", "r_label")])
# ============ 5. 绘制图表 ============
cat("\n开始绘图...\n")
# 创建图表
p <- ggplot(data_norm, aes(x = Year, y = Abundance_norm)) +
# 数据点
geom_point(color = "#377EB8", size = 3, alpha = 0.7, shape = 16) +
# 线性回归线
geom_smooth(method = "lm", formula = y ~ x,
color = "#E41A1C", fill = "#FF9999", alpha = 0.3,
linewidth = 1.0, se = TRUE) +
# 分面显示
facet_wrap(~ Type, ncol = 2, scales = "free_y") +
# 添加统计标注
geom_text(data = stats,
aes(x = label_x, y = label_y, label = stat_label),
size = 3.5, hjust = 1, vjust = 0.5,
color = "black") +
# 添加数据点数
#geom_text(data = stats,
#          aes(x = min(data_norm$Year),
#              y = max(data_norm$Abundance_norm) * 0.05,
#              label = paste("n =", n_points)),
#          size = 3, hjust = 0, vjust = 0,
#          color = "black") +
# 主题设置
theme_bw(base_size = 12) +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
panel.border = element_rect(color = "black", linewidth = 0.5),
strip.background = element_rect(fill = "gray95", color = "gray50"),
strip.text = element_text(face = "bold", size = 11),
axis.text = element_text(color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
plot.subtitle = element_text(hjust = 0.5, size = 11)
) +
# 标签和标题
labs(
x = "Year",
y = "Relative abundance",
title = "Temporal trends",
subtitle = "Linear regression analysis with Pearson correlation"
) +
# x轴刻度
scale_x_continuous(
breaks = seq(2012, 2024, by = 4),
limits = c(2011.5, 2024.5)
) +
# y轴限制
ylim(0, 1)
# 显示图表
print(p)
# ============ 6. 保存结果 ============
# 保存图表
#ggsave("Temporal_trends_plot.png", plot = p, width = 10, height = 6, dpi = 300, bg = "white")
#cat("图表已保存为 'Temporal_trends_plot.png'\n")
# 保存统计结果
write.csv(stats, "Statistical_results.csv", row.names = FALSE)
cat("统计结果已保存为 'Statistical_results.csv'\n")
# 保存清洗后的数据
write.csv(data_norm, "Cleaned_normalized_data.csv", row.names = FALSE)
cat("清洗后的数据已保存为 'Cleaned_normalized_data.csv'\n")
cat("\n分析完成！\n")
setwd("/Users/hewanyun/Downloads/linear regression")
# ============ 1. 加载包 ============
library(tidyverse)
library(ggpubr)
cat("开始分析...\n")
# ============ 2. 读取和清洗数据 ============
# 读取数据
data_raw <- read.csv("Linear_data.csv", header = TRUE)
# 清洗数据：选择需要的列，移除空行
data_clean <- data_raw %>%
# 只保留前三列（Type, Year, Relative_abundance）
select(1:3) %>%
# 重命名列
rename(
Type = 1,
Year = 2,
Relative_abundance = 3
) %>%
# 移除空行
filter(!is.na(Type) & !is.na(Year)) %>%
# 转换数据类型
mutate(
Year = as.numeric(Year),
Relative_abundance = as.numeric(Relative_abundance)
) %>%
# 移除相对丰度为NA的行
filter(!is.na(Relative_abundance))
# 检查清洗后的数据
cat("数据清洗完成！\n")
cat(paste("数据行数：", nrow(data_clean), "\n"))
cat(paste("类型数量：", length(unique(data_clean$Type)), "\n"))
cat("数据预览：\n")
print(head(data_clean, 10))
# 保持 Type 按数据中出现的顺序
type_order <- unique(data_clean$Type)
data_clean <- data_clean %>%
mutate(Type = factor(Type, levels = type_order))
# ============ 3. 计算归一化值 ============
# 对每个类型分别归一化到0-1
data_norm <- data_clean %>%
group_by(Type) %>%
mutate(
# 归一化公式：(x - min) / (max - min)
Abundance_norm = (Relative_abundance - min(Relative_abundance)) /
(max(Relative_abundance) - min(Relative_abundance))
) %>%
ungroup()
# 检查归一化结果
cat("\n归一化结果检查：\n")
for(arg in unique(data_norm$Type)){
subset_data <- data_norm[data_norm$Type == arg, ]
cat(paste(arg, ": 原始范围 [",
round(min(subset_data$Relative_abundance), 3), ", ",
round(max(subset_data$Relative_abundance), 3),
"], 归一化范围 [",
round(min(subset_data$Abundance_norm), 3), ", ",
round(max(subset_data$Abundance_norm), 3), "]\n", sep = ""))
}
# ============ 4. 计算统计值 ============
cat("\n计算统计值...\n")
stats <- data_norm %>%
group_by(Type) %>%
summarise(
# 基本统计
n_points = n(),
mean_abundance = mean(Relative_abundance),
# 线性回归
slope = lm(Abundance_norm ~ Year)$coefficients[2],
p_value = summary(lm(Abundance_norm ~ Year))$coefficients[2, 4],
R2 = summary(lm(Abundance_norm ~ Year))$r.squared,
# Pearson相关
r = cor(Abundance_norm, Year, method = "pearson"),
# 用于标注的位置
label_x = median(Year),
label_y = max(Abundance_norm) * 0.85,
.groups = "drop"
) %>%
# 格式化统计标签
mutate(
p_label = case_when(
p_value < 0.001 ~ "p < 0.001",
p_value < 0.01 ~ "p < 0.01",
p_value < 0.05 ~ sprintf("p < %.3f", p_value),
TRUE ~ sprintf("p = %.3f", p_value)
),
R2_label = sprintf("R² = %.3f", R2),
r_label = sprintf("r = %.3f", r),
# 合并标签
stat_label = paste(p_label, R2_label, r_label, sep = "\n")
)
# 显示统计结果
cat("统计结果：\n")
print(stats[, c("Type", "n_points", "p_label", "R2_label", "r_label")])
# ============ 5. 绘制图表 ============
cat("\n开始绘图...\n")
# 创建图表
p <- ggplot(data_norm, aes(x = Year, y = Abundance_norm)) +
# 数据点
geom_point(color = "#377EB8", size = 3, alpha = 0.7, shape = 16) +
# 线性回归线
geom_smooth(method = "lm", formula = y ~ x,
color = "#E41A1C", fill = "#FF9999", alpha = 0.3,
linewidth = 1.0, se = TRUE) +
# 分面显示
facet_wrap(~ Type, ncol = 2, scales = "free_y") +
# 添加统计标注
geom_text(data = stats,
aes(x = label_x, y = label_y, label = stat_label),
size = 3.5, hjust = 1, vjust = 0.5,
color = "black") +
# 添加数据点数
#geom_text(data = stats,
#          aes(x = min(data_norm$Year),
#              y = max(data_norm$Abundance_norm) * 0.05,
#              label = paste("n =", n_points)),
#          size = 3, hjust = 0, vjust = 0,
#          color = "black") +
# 主题设置
theme_bw(base_size = 12) +
theme(
panel.grid.minor = element_blank(),
panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
panel.border = element_rect(color = "black", linewidth = 0.5),
strip.background = element_rect(fill = "gray95", color = "gray50"),
strip.text = element_text(face = "bold", size = 11),
axis.text = element_text(color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
plot.subtitle = element_text(hjust = 0.5, size = 11)
) +
# 标签和标题
labs(
x = "Year",
y = "Relative abundance",
title = "Temporal trends",
subtitle = "Linear regression analysis with Pearson correlation"
) +
# x轴刻度
scale_x_continuous(
breaks = seq(2012, 2024, by = 4),
limits = c(2011.5, 2024.5)
) +
# y轴限制
ylim(0, 1)
# 显示图表
print(p)
# ============ 6. 保存结果 ============
# 保存图表
#ggsave("Temporal_trends_plot.png", plot = p, width = 10, height = 6, dpi = 300, bg = "white")
#cat("图表已保存为 'Temporal_trends_plot.png'\n")
# 保存统计结果
write.csv(stats, "Statistical_results.csv", row.names = FALSE)
cat("统计结果已保存为 'Statistical_results.csv'\n")
# 保存清洗后的数据
write.csv(data_norm, "Cleaned_normalized_data.csv", row.names = FALSE)
cat("清洗后的数据已保存为 'Cleaned_normalized_data.csv'\n")
cat("\n分析完成！\n")
