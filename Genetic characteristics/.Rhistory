axis.line.y = element_blank(),
axis.ticks.y = element_blank()
) +
geom_text_repel(
data = label_df,
aes(label = clone),
nudge_x = 0.5,
direction = "y",
size = 4,
segment.color = NA
)
print(p)
})
# 保存结果
# =====================================================
#ggsave("ST410_stream.pdf",  width = 11, height = 7, dpi = 300, bg = "white")
#install.packages("devtools")
#devtools::install_github("davidsjoberg/ggstream")
setwd("/Users/hewanyun/Downloads/stream")
# library
library(ggplot2)
library(ggstream)
library(dplyr)
library(ggrepel)
library(readr)
library(scales)
# 读取数据
df <- read_csv("ST410_subclones.csv")
# =====================================================
# 关键修复：添加排序变量，确保流图正确堆叠
# =====================================================
# 1. 首先固定克隆顺序（按名称字母排序或自定义）
clone_order <- c("A/H53", "B1/H24", "B2/H24R", "B3/H24Rx_1","B3/H24Rx_2","B4/H24RxC", "B5/H24RxC")
# 2. 给每个克隆一个固定的排序值
clone_sort_values <- setNames(1:8, clone_order)
# 3. 准备数据 - 关键步骤！
df_prepared <- df %>%
mutate(
year = factor(year, levels = unique(year)),
clone = factor(clone, levels = clone_order),
# 添加排序变量：按克隆顺序固定
sort_value = clone_sort_values[as.character(clone)]
) %>%
arrange(year, sort_value)  # 按年份和固定顺序排序
# 4. 重新计算累积比例，确保正确堆叠
df_final <- df_prepared %>%
group_by(year) %>%
arrange(sort_value) %>%  # 按固定顺序排列
mutate(
cumsum_prevalence = cumsum(prevalence),
y_start = lag(cumsum_prevalence, default = 0)
) %>%
ungroup()
# =====================================================
# label_df 在 factor 之后生成
# =====================================================
label_df <- df_final %>%
group_by(clone) %>%
slice_tail(n = 1)
# =====================================================
# ISME / Nature 风格配色
# =====================================================
clone_cols <- c(
"A/H53"      = "#9B7FCB",
"B1/H24"     = "#95765C",
"B2/H24R"    = "#B2BC8A",
"B3/H24Rx_1"   = "#ffe699",
"B3/H24Rx_2"   = "#fecc66",
"B4/H24RxC"  = "#76D5FF",
"B5/H24RxC"  = "#FF7E79"
)
# =====================================================
try({
p <- ggplot(df_final, aes(x = year, y = prevalence, fill = clone)) +
geom_stream(
type = "proportional",
bw = 0.65,  # 调整为更小的值
extra_span = 0.15,
color = "white",
linewidth = 0.15,
sorting = "onset"  # 尝试不同的排序方式
) +
scale_fill_manual(values = clone_cols) +
scale_y_continuous(labels = percent) +
labs(
x = "Year",
y = "Relative prevalence",
title = "Temporal dynamics"
) +
theme_classic(base_size = 14) +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"),
legend.position = "none",
axis.line.y = element_blank(),
axis.ticks.y = element_blank()
) +
geom_text_repel(
data = label_df,
aes(label = clone),
nudge_x = 0.5,
direction = "y",
size = 4,
segment.color = NA
)
print(p)
})
# 保存结果
# =====================================================
#ggsave("ST410_stream.pdf",  width = 11, height = 7, dpi = 300, bg = "white")
#install.packages("devtools")
#devtools::install_github("davidsjoberg/ggstream")
setwd("/Users/hewanyun/Downloads/stream")
# library
library(ggplot2)
library(ggstream)
library(dplyr)
library(ggrepel)
library(readr)
library(scales)
# 读取数据
df <- read_csv("ST410_subclones.csv")
# =====================================================
# 关键修复：添加排序变量，确保流图正确堆叠
# =====================================================
# 1. 首先固定克隆顺序（按名称字母排序或自定义）
clone_order <- c("A/H53", "B1/H24", "B2/H24R", "B3/H24Rx_1","B3/H24Rx_2","B4/H24RxC", "B5/H24RxC")
# 2. 给每个克隆一个固定的排序值
clone_sort_values <- setNames(1:8, clone_order)
# 3. 准备数据 - 关键步骤！
df_prepared <- df %>%
mutate(
year = factor(year, levels = unique(year)),
clone = factor(clone, levels = clone_order),
# 添加排序变量：按克隆顺序固定
sort_value = clone_sort_values[as.character(clone)]
) %>%
arrange(year, sort_value)  # 按年份和固定顺序排序
# 4. 重新计算累积比例，确保正确堆叠
df_final <- df_prepared %>%
group_by(year) %>%
arrange(sort_value) %>%  # 按固定顺序排列
mutate(
cumsum_prevalence = cumsum(prevalence),
y_start = lag(cumsum_prevalence, default = 0)
) %>%
ungroup()
# =====================================================
# label_df 在 factor 之后生成
# =====================================================
label_df <- df_final %>%
group_by(clone) %>%
slice_tail(n = 1)
# =====================================================
# ISME / Nature 风格配色
# =====================================================
clone_cols <- c(
"A/H53"      = "#9B7FCB",
"B1/H24"     = "#95765C",
"B2/H24R"    = "#B2BC8A",
"B3/H24Rx_1"   = "#ffe699",
"B3/H24Rx_2"   = "#fecc66",
"B4/H24RxC"  = "#76D5FF",
"B5/H24RxC"  = "#FF7E79"
)
# =====================================================
try({
p <- ggplot(df_final, aes(x = year, y = prevalence, fill = clone)) +
geom_stream(
type = "proportional",
bw = 0.65,  # 调整为更小的值
extra_span = 0.15,
color = "white",
linewidth = 0.15,
sorting = "onset"  # 尝试不同的排序方式
) +
scale_fill_manual(values = clone_cols) +
scale_y_continuous(labels = percent) +
labs(
x = "Year",
y = "Relative prevalence",
title = "Temporal dynamics"
) +
theme_classic(base_size = 14) +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"),
legend.position = "none",
axis.line.y = element_blank(),
axis.ticks.y = element_blank()
) +
geom_text_repel(
data = label_df,
aes(label = clone),
nudge_x = 0.5,
direction = "y",
size = 4,
segment.color = NA
)
print(p)
})
# 保存结果
# =====================================================
#ggsave("ST410_stream.pdf",  width = 11, height = 7, dpi = 300, bg = "white")
#install.packages("devtools")
#devtools::install_github("davidsjoberg/ggstream")
setwd("/Users/hewanyun/Downloads/stream")
# library
library(ggplot2)
library(ggstream)
library(dplyr)
library(ggrepel)
library(readr)
library(scales)
# 读取数据
df <- read_csv("ST410_subclones.csv")
# =====================================================
# 关键修复：添加排序变量，确保流图正确堆叠
# =====================================================
# 1. 首先固定克隆顺序（按名称字母排序或自定义）
clone_order <- c("A/H53", "B1/H24", "B2/H24R", "B3/H24Rx_1","B3/H24Rx_2","B4/H24RxC", "B5/H24RxC")
# 2. 给每个克隆一个固定的排序值
clone_sort_values <- setNames(1:8, clone_order)
# 3. 准备数据 - 关键步骤！
df_prepared <- df %>%
mutate(
Year = factor(Year, levels = unique(Year)),
Clone = factor(Clone, levels = clone_order),
# 添加排序变量：按克隆顺序固定
sort_value = clone_sort_values[as.character(Clone)]
) %>%
arrange(Year, sort_value)  # 按年份和固定顺序排序
#install.packages("devtools")
#devtools::install_github("davidsjoberg/ggstream")
setwd("/Users/hewanyun/Downloads/stream")
# library
library(ggplot2)
library(ggstream)
library(dplyr)
library(ggrepel)
library(readr)
library(scales)
# 读取数据
df <- read_csv("ST410_subclones.csv")
# =====================================================
# 关键修复：添加排序变量，确保流图正确堆叠
# =====================================================
# 1. 首先固定克隆顺序（按名称字母排序或自定义）
clone_order <- c("A/H53", "B1/H24", "B2/H24R", "B3/H24Rx_1","B3/H24Rx_2","B4/H24RxC", "B5/H24RxC")
# 2. 给每个克隆一个固定的排序值
clone_sort_values <- setNames(1:8, clone_order)
# 3. 准备数据 - 关键步骤！
df_prepared <- df %>%
mutate(
Year = factor(Year, levels = unique(Year)),
Clone = factor(Clone, levels = clone_order),
# 添加排序变量：按克隆顺序固定
sort_value = clone_sort_values[as.character(Clone)]
) %>%
arrange(Year, sort_value)  # 按年份和固定顺序排序
# 4. 重新计算累积比例，确保正确堆叠
df_final <- df_prepared %>%
group_by(Year) %>%
arrange(sort_value) %>%  # 按固定顺序排列
mutate(
cumsum_prevalence = cumsum(Prevalence),
y_start = lag(cumsum_prevalence, default = 0)
) %>%
ungroup()
# =====================================================
# label_df 在 factor 之后生成
# =====================================================
label_df <- df_final %>%
group_by(Clone) %>%
slice_tail(n = 1)
# =====================================================
# ISME / Nature 风格配色
# =====================================================
clone_cols <- c(
"A/H53"      = "#9B7FCB",
"B1/H24"     = "#95765C",
"B2/H24R"    = "#B2BC8A",
"B3/H24Rx_1"   = "#ffe699",
"B3/H24Rx_2"   = "#fecc66",
"B4/H24RxC"  = "#76D5FF",
"B5/H24RxC"  = "#FF7E79"
)
# =====================================================
try({
p <- ggplot(df_final, aes(x = Year, y = Prevalence, fill = Clone)) +
geom_stream(
type = "proportional",
bw = 0.65,  # 调整为更小的值
extra_span = 0.15,
color = "white",
linewidth = 0.15,
sorting = "onset"  # 尝试不同的排序方式
) +
scale_fill_manual(values = clone_cols) +
scale_y_continuous(labels = percent) +
labs(
x = "Year",
y = "Relative prevalence",
title = "Temporal dynamics"
) +
theme_classic(base_size = 14) +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, color = "black"),
legend.position = "none",
axis.line.y = element_blank(),
axis.ticks.y = element_blank()
) +
geom_text_repel(
data = label_df,
aes(label = Clone),
nudge_x = 0.5,
direction = "y",
size = 4,
segment.color = NA
)
print(p)
})
# 保存结果
# =====================================================
#ggsave("ST410_stream.pdf",  width = 11, height = 7, dpi = 300, bg = "white")
setwd("/Users/hewanyun/Downloads/bubble")
library(ggplot2)
library(dplyr)
# 关闭自动因子
df <- read.csv("Temporal_data.csv", stringsAsFactors = FALSE)
df2 <- df %>%
filter(Relative_abundance > 0)
df2$Type <- factor(df2$Type, levels = unique(df2$Type))
df2$Year <- factor(df2$Year, levels = unique(df$Year))
# 创建条形背景数据
bg <- data.frame(
Type = levels(df2$Type),
y_min = seq_along(levels(df2$Type)) - 0.5,
y_max = seq_along(levels(df2$Type)) + 0.5
)
bg <- bg %>% mutate(fill_color = ifelse(row_number() %% 2 == 0, "grey95", NA))
ggplot() +
geom_rect(
data = bg %>% filter(!is.na(fill_color)),
aes(xmin = -Inf, xmax = Inf, ymin = y_min, ymax = y_max),
fill = "grey95",
inherit.aes = FALSE
) +
geom_point(
data = df2,
aes(
x = Year,
y = Type,
size = Relative_abundance,
fill = Relative_abundance   # ★关键修改
),
shape = 21,
color = "black",
alpha = 0.85
) +
scale_size_continuous(
limits = c(0, max(df2$Relative_abundance)),
breaks = seq(0.1, max(df2$Relative_abundance), by = 0.2),
range  = c(1.5, 10)
) +
scale_fill_gradient(               # ★蓝色渐变#deebf7 #08519c ; 红色渐变#FFF5F5 #C53030
#low  = "#deebf7",   # 浅蓝（小值）
#high = "#08519c",   # 深蓝（大值）
low  = "#FFF5F5",   # 浅红（小值）
high = "#C53030",   # 深红（大值）
name = "Relative abundance"
) +
scale_x_discrete(position = "top") +
theme_bw(base_size = 12) +
theme(
panel.grid = element_blank(),
panel.border = element_rect(color = "black", fill = NA),
axis.text.x = element_text(face = "bold", angle = 90, hjust = 0, vjust = 0.5,
size = 10, color = "black"),
axis.text.y = element_text(face = "bold", size = 10, color = "black"),
axis.title = element_text(size = 12, color = "black"),
legend.title = element_text(size = 11, color = "black"),
legend.text = element_text(color = "black")
) +
labs(
x = "Year",
y = NULL,
size = "Relative abundance"
)
setwd("/Users/hewanyun/Downloads/bubble")
library(ggplot2)
library(dplyr)
# 关闭自动因子
df <- read.csv("Temporal_data.csv", stringsAsFactors = FALSE)
df2 <- df %>%
filter(Relative_abundance > 0)
df2$Type <- factor(df2$Type, levels = unique(df2$Type))
df2$Year <- factor(df2$Year, levels = unique(df$Year))
# 创建条形背景数据
bg <- data.frame(
Type = levels(df2$Type),
y_min = seq_along(levels(df2$Type)) - 0.5,
y_max = seq_along(levels(df2$Type)) + 0.5
)
bg <- bg %>% mutate(fill_color = ifelse(row_number() %% 2 == 0, "grey95", NA))
ggplot() +
geom_rect(
data = bg %>% filter(!is.na(fill_color)),
aes(xmin = -Inf, xmax = Inf, ymin = y_min, ymax = y_max),
fill = "grey95",
inherit.aes = FALSE
) +
geom_point(
data = df2,
aes(
x = Year,
y = Type,
size = Relative_abundance,
fill = Relative_abundance   # ★关键修改
),
shape = 21,
color = "black",
alpha = 0.85
) +
scale_size_continuous(
limits = c(0, max(df2$Relative_abundance)),
breaks = seq(0.1, max(df2$Relative_abundance), by = 0.2),
range  = c(1.5, 10)
) +
scale_fill_gradient(               # ★蓝色渐变#deebf7 #08519c ; 红色渐变#FFF5F5 #C53030
#low  = "#deebf7",   # 浅蓝（小值）
#high = "#08519c",   # 深蓝（大值）
low  = "#FFF5F5",   # 浅红（小值）
high = "#C53030",   # 深红（大值）
name = "Relative abundance"
) +
scale_x_discrete(position = "top") +
theme_bw(base_size = 12) +
theme(
panel.grid = element_blank(),
panel.border = element_rect(color = "black", fill = NA),
axis.text.x = element_text(face = "bold", angle = 90, hjust = 0, vjust = 0.5,
size = 10, color = "black"),
axis.text.y = element_text(face = "bold", size = 10, color = "black"),
axis.title = element_text(size = 12, color = "black"),
legend.title = element_text(size = 11, color = "black"),
legend.text = element_text(color = "black")
) +
labs(
x = "Year",
y = NULL,
size = "Relative abundance"
)
setwd("/Users/hewanyun/Downloads/bubble")
library(ggplot2)
library(dplyr)
# 关闭自动因子
df <- read.csv("Temporal_data.csv", stringsAsFactors = FALSE)
df2 <- df %>%
filter(Relative_abundance > 0)
df2$Type <- factor(df2$Type, levels = unique(df2$Type))
df2$Year <- factor(df2$Year, levels = unique(df$Year))
# 创建条形背景数据
bg <- data.frame(
Type = levels(df2$Type),
y_min = seq_along(levels(df2$Type)) - 0.5,
y_max = seq_along(levels(df2$Type)) + 0.5
)
bg <- bg %>% mutate(fill_color = ifelse(row_number() %% 2 == 0, "grey95", NA))
ggplot() +
geom_rect(
data = bg %>% filter(!is.na(fill_color)),
aes(xmin = -Inf, xmax = Inf, ymin = y_min, ymax = y_max),
fill = "grey95",
inherit.aes = FALSE
) +
geom_point(
data = df2,
aes(
x = Year,
y = Type,
size = Relative_abundance,
fill = Relative_abundance   # ★关键修改
),
shape = 21,
color = "black",
alpha = 0.85
) +
scale_size_continuous(
limits = c(0, max(df2$Relative_abundance)),
breaks = seq(0.1, max(df2$Relative_abundance), by = 0.2),
range  = c(1.5, 10)
) +
scale_fill_gradient(               # ★蓝色渐变#deebf7 #08519c ; 红色渐变#FFF5F5 #C53030
#low  = "#deebf7",   # 浅蓝（小值）
#high = "#08519c",   # 深蓝（大值）
low  = "#FFF5F5",   # 浅红（小值）
high = "#C53030",   # 深红（大值）
name = "Relative abundance"
) +
scale_x_discrete(position = "top") +
theme_bw(base_size = 12) +
theme(
panel.grid = element_blank(),
panel.border = element_rect(color = "black", fill = NA),
axis.text.x = element_text(face = "bold", angle = 90, hjust = 0, vjust = 0.5,
size = 10, color = "black"),
axis.text.y = element_text(face = "bold", size = 10, color = "black"),
axis.title = element_text(size = 12, color = "black"),
legend.title = element_text(size = 11, color = "black"),
legend.text = element_text(color = "black")
) +
labs(
x = "Year",
y = NULL,
size = "Relative abundance"
)
